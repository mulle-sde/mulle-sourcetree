#! /usr/bin/env bash

[ "${TRACE}" = 'YES' ] && set -x && : "$0" "$@"

###   ###   ###   ###   ###   ###   ###   ###   ###   ###   ###   ###   ###
MULLE_BASHFUNCTIONS_LIBEXEC_DIR="`mulle-bashfunctions libexec-dir`" || exit 1
export MULLE_BASHFUNCTIONS_LIBEXEC_DIR
. "${MULLE_BASHFUNCTIONS_LIBEXEC_DIR}/mulle-boot.sh" || exit 1
. "${MULLE_BASHFUNCTIONS_LIBEXEC_DIR}/mulle-bashfunctions.sh" || exit 1
###   ###   ###   ###   ###   ###   ###   ###   ###   ###   ###   ###   ###

main()
{
   _options_mini_main "$@" && set -x

   local _marks

   sourcetree::nodemarks::contain  "${_marks}" "build"   || internal_fail "Did expect build as default"
   sourcetree::nodemarks::contain  "${_marks}" "recurse" || internal_fail "Did expect recurse as default"
   sourcetree::nodemarks::contain  "${_marks}" "delete"  || internal_fail "Did expect delete as default"
   sourcetree::nodemarks::contain  "${_marks}" "require" || internal_fail "Did expect require as default"
   sourcetree::nodemarks::contain  "${_marks}" "update"  || internal_fail "Did expect update as default"

   log_verbose "----- #1 PASSED -----"

   sourcetree::nodemarks::contain  "${_marks}" "no-build"    && internal_fail "Did not expect no-build as default"
   sourcetree::nodemarks::contain  "${_marks}" "no-delete"   && internal_fail "Did not expect no-delete as default"
   sourcetree::nodemarks::contain  "${_marks}" "no-recurse"  && internal_fail "Did not expect no-recurse as default"
   sourcetree::nodemarks::contain  "${_marks}" "no-require"  && internal_fail "Did not expect no-require as default"
   sourcetree::nodemarks::contain  "${_marks}" "no-update"   && internal_fail "Did not expect no-update as default"

   log_verbose "----- #2 PASSED -----"

   _marks="`sourcetree::nodemarks::remove "${_marks}" "build"`"

   sourcetree::nodemarks::contain "${_marks}" "build"     && internal_fail "Did expect no-build ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "delete"    || internal_fail "Did not expect no-delete ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "recurse"   || internal_fail "Did not expect no-recurse ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "require"   || internal_fail "Did not expect no-require ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "update"    || internal_fail "Did not expect no-update ($_marks)"

   log_verbose "----- #3 PASSED -----"

   _marks="`sourcetree::nodemarks::remove "${_marks}" "delete"`"

   sourcetree::nodemarks::contain "${_marks}" "build"     && internal_fail "Did expect no-build ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "delete"    && internal_fail "Did expect no-delete ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "recurse"   || internal_fail "Did not expect no-recurse ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "require"   || internal_fail "Did not expect no-require ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "update"    || internal_fail "Did not expect no-update ($_marks)"

   log_verbose "----- #4 PASSED -----"

   _marks="`sourcetree::nodemarks::remove "${_marks}" "recurse"`"

   sourcetree::nodemarks::contain "${_marks}" "build"     && internal_fail "Did expect no-build ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "delete"    && internal_fail "Did expect no-delete ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "recurse"   && internal_fail "Did expect no-recurse ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "require"   || internal_fail "Did not expect no-require ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "update"    || internal_fail "Did not expect no-update ($_marks)"

   log_verbose "----- #5 PASSED -----"

   _marks="`sourcetree::nodemarks::remove "${_marks}" "require"`"

   sourcetree::nodemarks::contain "${_marks}" "build"    && internal_fail "Did expect no-build ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "delete"   && internal_fail "Did expect no-delete ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "recurse"  && internal_fail "Did expect no-recurse ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "require"  && internal_fail "Did expect no-require ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "update"   || internal_fail "Did not expect no-update ($_marks)"

   log_verbose "----- #6 PASSED -----"

   _marks="`sourcetree::nodemarks::remove "${_marks}" "update"`"

   sourcetree::nodemarks::contain "${_marks}" "build"   && internal_fail "Did expect no-build ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "delete"  && internal_fail "Did expect no-delete ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "recurse" && internal_fail "Did expect no-recurse ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "require" && internal_fail "Did expect no-require ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "update"  && internal_fail "Did expect no-update ($_marks)"

   log_verbose "----- #7 PASSED -----"

# remove stuff

   _marks="`sourcetree::nodemarks::add "${_marks}" "build"`"

   sourcetree::nodemarks::contain "${_marks}" "build"    || internal_fail "Did not expect no-build ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "delete"   && internal_fail "Did expect no-delete ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "recurse"  && internal_fail "Did expect no-recurse ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "require"  && internal_fail "Did expect no-require ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "update"   && internal_fail "Did expect no-update ($_marks)"

   log_verbose "----- #8 PASSED -----"

   _marks="`sourcetree::nodemarks::add "${_marks}" "delete"`"

   sourcetree::nodemarks::contain "${_marks}" "build"    || internal_fail "Did not expect no-build ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "delete"   || internal_fail "Did not expect no-delete ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "recurse"  && internal_fail "Did expect no-recurse ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "require"  && internal_fail "Did expect no-require ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "update"   && internal_fail "Did expect no-update ($_marks)"

   log_verbose "----- #9 PASSED -----"

   _marks="`sourcetree::nodemarks::add "${_marks}" "recurse"`"

   sourcetree::nodemarks::contain "${_marks}" "build"    || internal_fail "Did not expect no-build ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "delete"   || internal_fail "Did not expect no-delete ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "recurse"  || internal_fail "Did not expect no-recurse ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "require"  && internal_fail "Did expect no-require ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "update"   && internal_fail "Did expect no-update ($_marks)"

   log_verbose "----- #10 PASSED -----"

   _marks="`sourcetree::nodemarks::add "${_marks}" "require"`"

   sourcetree::nodemarks::contain "${_marks}" "build"   || internal_fail "Did not expect no-build ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "delete"  || internal_fail "Did not expect no-delete ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "recurse" || internal_fail "Did not expect no-recurse ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "require" || internal_fail "Did not expect no-require ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "update"  && internal_fail "Did expect no-update ($_marks)"

   log_verbose "----- #11 PASSED -----"

   _marks="`sourcetree::nodemarks::add "${_marks}" "update"`"

   sourcetree::nodemarks::contain "${_marks}" "build"    || internal_fail "Did not expect no-build ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "delete"   || internal_fail "Did not expect no-delete ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "recurse"  || internal_fail "Did not expect no-recurse ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "require"  || internal_fail "Did not expect no-require ($_marks)"
   sourcetree::nodemarks::contain "${_marks}" "update"   || internal_fail "Did not expect no-update ($_marks)"

   log_verbose "----- #12 PASSED -----"

   local other

   _marks="`sourcetree::nodemarks::remove "" "update"`"
   _marks="`sourcetree::nodemarks::remove "${_marks}" "delete"`"

   other="`sourcetree::nodemarks::remove "" "delete"`"

   sourcetree::nodemarks::intersect "no-delete,no.u" "${other}" || internal_fail "intersect \"${_marks}\" \"${other}\""

   log_verbose "----- #13 PASSED -----"

   _marks="`sourcetree::nodemarks::remove "" "update"`"
   other="`sourcetree::nodemarks::remove "" "delete"`"

   sourcetree::nodemarks::intersect "${_marks}" "${other}" && internal_fail "! intersect \"${_marks}\" \"${other}\""

   log_verbose "----- #14 PASSED -----"

   _marks="no-c,no-a,no-b"
   sourcetree::nodemarks::sort "${_marks}"
   other="${RVAL}"

   [ "${other}" = "no-a,no-b,no-c" ] || internal_fail "did not sort \"${other}\""

   log_verbose "----- #15 PASSED -----"

   _marks="no-b,no-c,no-a"
   sourcetree::nodemarks::sort "${_marks}"
   other="${RVAL}"

   [ "${other}" = "no-a,no-b,no-c" ] || internal_fail "did not sort \"${other}\""

   log_verbose "----- #16 PASSED -----"

   _marks="no-b,no-c,no-a,only-d"

   sourcetree::nodemarks::match "${_marks}" "no-b"       || internal_fail "Did not match no-b ($_marks)"
   sourcetree::nodemarks::match "${_marks}" "no-x"       && internal_fail "Did match no-x ($_marks)"
   sourcetree::nodemarks::match "${_marks}" "no-[ab]"    || internal_fail "Did not match no-[ab] ($_marks)"
   sourcetree::nodemarks::match "${_marks}" "no-*"       || internal_fail "Did not match no-* ($_marks)"
   sourcetree::nodemarks::match "${_marks}" "only-*"     || internal_fail "Did not match only-* ($_marks)"
   sourcetree::nodemarks::match "${_marks}" "only-c"     && internal_fail "Did match only-c ($_marks)"

   log_verbose "----- #17 PASSED -----"

   log_info "----- ALL PASSED -----"
}



init()
{
   MULLE_SOURCETREE="${MULLE_SOURCETREE:-${PWD}/../../mulle-sourcetree}"
   MULLE_SOURCETREE_LIBEXEC_DIR="`${MULLE_SOURCETREE} library-path`" || exit 1

   . "${MULLE_SOURCETREE_LIBEXEC_DIR}/mulle-sourcetree-nodemarks.sh" || exit 1
}


init "$@"
main "$@"
